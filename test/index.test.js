const PlonkVerifier = artifacts.require('PlonkVerifier')

const fs= require('fs')
const { plonk } = require('snarkjs')
const { utils } = require("ffjavascript");
const { unstringifyBigInts } = utils;

contract('PlonkVerifier', () => {
  let verifier = null

  it('initialization', async () => {
    verifier = await PlonkVerifier.new()
    // const test = await verifier.test.call()

    // assert.equal(test.valueOf(), 42, 'initialization error')
  })

  it('can verify', async () => {
    // const proof = [
    //   [0, 0, 0, 0],
    //   [
    //     [
    //       '594476778351543693623182262097834998830026499323890699872502437340265883736',
    //       '11138148742172743821269001527522774419034328252284481412587122967722698849290',
    //     ],
    //     [
    //       '16988511013495360245480563426690919669258873728847167534483020190034280476142',
    //       '7690884383686701489724130432182524583154338824945792131033321852580922834835',
    //     ],
    //     [
    //       '14750912893914679006872222158766588469857665657000202622551542322840640583548',
    //       '7449771727960574255059109935877218648722395938867957119204101734800514363612',
    //     ],
    //   ], // abc
    //   [
    //     '1221793087184080053543516341515648316603827204892680018821632993866562284772',
    //     '1393019551780324211868162829881141593081535791717041811397170102358231997158',
    //   ], // z
    //   [
    //     [
    //       '106240385429922790006304914823251186024135017389955182129201281796587846931',
    //       '13622643429880178749639693898343076478307946493431548961689529255788054499889',
    //     ],
    //     [
    //       '9192441544880966631260314851905938841390508492840335357157284939279250552077',
    //       '7570559003449969015057120557838808432517822370579950639299754129070419758843',
    //     ],
    //     [
    //       '7087346970662377867758448360849252754250060148089969125635685678506526617607',
    //       '7395228979775793488657685381967937991224457450131796282771109905859621767169',
    //     ],
    //   ], // t
    //   [
    //     ['4541048734516535128845231557055927225042336988981539618395153840322584980389'],
    //     ['15776193294210745169799383860962193414359706174313127853847803580994615376591'],
    //     ['6584279185101651069614797372532458148942679994682461772209192873084913367960'],
    //   ],
    //   ['11319220531976246239681551483899404477295303665041681461820376667619378219900'],
    //   ['15794956774158904351606747575091145020757228006229228194018827461355852755859'],
    //   ['10226390296738572000586020641836306372140448879958659378103364447108688106024'],
    //   [
    //     ['18292239692626280844447445246203069344773166963401944699579184196610619976184'],
    //     ['2545119322393522288860947374040065139955988451279616812980961106510828092291'],
    //   ], // sigam
    //   [
    //     '18889419035524852273906886002593758661088331730692952604750294729011358113690',
    //     '7211031983153934433068056236562777502906276950910502670498850085188670954815',
    //   ],
    //   [
    //     '8723629029486532637554723971251827809244379053483711686717418536067147115884',
    //     '8101898248330553924390358101659418761457918957779251740823643841466732107162',
    //   ],
    // ]
    // const vk = [
    //   4, // domain_size
    //   4, // num_inputs
    //   ['0x30644e72e131a029048b6e193fd841045cea24f6fd736bec231204708f703636'], // omega
    //   [
    //     [
    //       '0x2c2c205c4543fbf96d4e00a1867fa9fd6b4adc8e1e63967d6d2bf4080378e16d',
    //       '0x303e034fa6dc771b84fcc4cdaf0e55be886adcf8f8449bfb462e4953bb10e866',
    //     ],
    //     [
    //       '0x2c2c205c4543fbf96d4e00a1867fa9fd6b4adc8e1e63967d6d2bf4080378e16d',
    //       '0x303e034fa6dc771b84fcc4cdaf0e55be886adcf8f8449bfb462e4953bb10e866',
    //     ],
    //     [
    //       '0x1',
    //       '0x30644e72e131a029b85045b68181585d97816a916871ca8d3c208c16d87cfd45',
    //     ],
    //     [
    //       '0xd710d3e1642b7126ca5592fcb6c6e131b9cd45091ed2af3e8ef14d67565e957',
    //       '0x17cb785604229f409460c98c26fe3789dc58569b9dab073a3e6174015e433f3',
    //     ],
    //     [
    //       '0x0',
    //       '0x0',
    //     ],
    //   ], // selector_commitments
    //   [
    //     [
    //       '0x1cfd17abd96b518c0552897243def209470f8e12bb32c37e574adbb20c6a900a',
    //       '0xe43639b48ba7e2e8c57482814e90fe6a5e142b17e5ea9aa68a036d2fb0b6a13',
    //     ],
    //     [
    //       '0x24f67fdf66438e753c432c5ce23926002c6631f4a18b99ce78c3dee532bcdb71',
    //       '0xc0f9fb65aefe05f3e232a593dd6e68cbda102e2dfc0d8e58501cb5be63befd0',
    //     ],
    //     [
    //       '0x296fcbb175040681d71ad7bc5b3d2a76ba9161c91620b2352527f73947f220f1',
    //       '0x1e89a0a49a0e3262eb9ff0c223bf1b53e5793c4ed5069a80403f0879dcd0a1d',
    //     ],
    //   ], // permutation_commitments
    //   [
    //     ['0x0000000000000000000000000000000000000000000000000000000000000005'],
    //     ['0x0000000000000000000000000000000000000000000000000000000000000007'],
    //   ], // permutation_non_residues
    //   [
    //     [
    //       '0x19ec5ad0b21f625e7f8eca8841cbd8770106eb7efb06989fd3298ed567597995',
    //       '0x27f29cdb17cbfd46d12d168cadb420d700119e2f04180723025b8be9693e91f6',
    //     ],
    //     [
    //       '0x2065616c257a1bfcc4e3ed1175bf0cd77809680ffeb60b274e9d4dad14cbada7',
    //       '0x2423b65cb38edc67d762d937621acc47d1e03744a60ba78c95521ae0064c2463',
    //     ],
    //   ]
    // ]

    // const vk = ["6251314467110089072124322128896531814217039722942254099547280120539657320182","13771957130939383958960908319851349425260133206022350812095121562170212712800","20877456850737041203414626429389382213883777139504867610310062529030780427427","16437290059222594006885630490420659502286658343602075856775519526170651237632","0","1","6251314467110089072124322128896531814217039722942254099547280120539657320182","8116285740899891263285497425405925663436177951275472850593916332475013495783","0","1","12808452100463403342729731144574473930654101141820284800711593959326599343924","10472887019323998228258735394867170748525597275011042145037222711442278304214","14253736553615916980637182612603035283705466102645795980642665802782317724620","21126119128683917238105017100394666291848499630024557430133868231495575303531","20479549671363456870495026508479754748182161875087290436122333055517466065844","14850584523722841414418836917020978639776463623046500600399970227226397845642","5602008701156535630537858604340465312722721718419014785993351761195187677962","13842355370624335640834348335600764647553591083998301695634442246250629437950","19502858131529532718967293623890338452117366689781139468918810470042131851449","6030393889663866820130692033380219747907049209429871635120170840614571867985","19540430494807482326159819597004422086093766032135589407132600596362845576832"]

    const vk = '0x00000000000000000000000000000000000000000000000000000000000000030dd21e5cb67dfe9849ce76fbf28601ed560626c32c4ac6320671a22b3d1cb6f61e72a6c8f888e03dbf825951980d9b61119e0710be057018a008a7ff254381602e2838c99d59c07ec4c218231882e5b5c8f1416f495ee58f986569c76b291ca324572d2de20d5f53bbc5462ae96b5a8e82b827f9e7b248397ee7fe1456eb9d00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000dd21e5cb67dfe9849ce76fbf28601ed560626c32c4ac6320671a22b3d1cb6f611f1a7a9e8a8bfebf8cdec64e973bcfc85e36380aa6c5a749c17e417b3397be7000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001c5153b51e4507024685fb730d9850f442b2171a490564d912644db6e7b7ef34172771a979adef7fd6dc4dc15210b5dce6c3148ffe587ab1d2fa4c49e07dc9d61f835438f3129ecc8a28d1e1b43aa87b70fc22803cadd0feba21899d62cbc3cc2eb4f5ae1f68fcd11e9efe01a51baae55eb0ac3a291fe0a3a094dbd86946756b2d4703ac0b15a396c9c1e83fbf676d9e97017202c249277336482d0d69347bb420d5220a91246adfdcc23ed8250b4c9fde27d3b7b9683a5db94483812cb7288a0c629fe34e2af1369ea4350edbe65a1757c11e851328f8e2a9c1b1857671ab0a1e9a7ed8cea536b9be9344f4b00e3160c576103a870dde88334640aa9f0c19fe2b1e39fd5fe18c3407658f0f76d7c0fb0d83bf71266f8ff57b47e313427568b90d5514fd10eb4fee38483e6e8be226d18d35004c26582ff095dded8fbd83ff512b337de1c8c14f22ec9b9e2f96afef3652627366f8170a0a948dad4ac1bd5e80'

    const proof = JSON.parse(fs.readFileSync('./demo1/proof.json'))

    const editedPublicSignals = [8n]
    const editedProof = unstringifyBigInts(proof)
    const calldata = await plonk.exportSolidityCallData(
      editedProof,
      editedPublicSignals
    );
    const p = calldata.split(",")[0];
    // const pub_sig = JSON.parse(calldata.split(",")[1]);
    // console.log(p, pub_sig)

    const pass = await verifier.verifyProof(vk, p, '85')

    console.log(pass)

    // assert.equal(pass, true, 'verify error')
    // console.log(parse(pass))

    // const test2 = await verifier.test2()
    // console.log(test2.valueOf())
  })
})

function parse(input) {
  const res = []
  for (let i = 0; i < 100; i++) {
    if (!input[i]) {
      break
    }
    const v = input[i][0] || input[i].value
    const hex = BigInt(v).toString(16)
    res[i] = hex
  }
  return res
}

/*
[DEBUG] snarkJS: beta: 11319120bcd12f63711ccc50e05f467f8a9e5eb9fdcb906e32fbafd1658c2c97
[DEBUG] snarkJS: gamma: f7aa8b67ed9f6c12b0f3427f20dfd548424c6fffa7d9d6a9944d05463a49651
[DEBUG] snarkJS: alpha: 1ab550c06e00ac2bd695f3dd148109b516e4fe65d249d9252a60835bf9701415
[DEBUG] snarkJS: xi: d52268e4d7fe2303c5da372a28338ab8723dd6da7799bc63f4f7fc031778445
[DEBUG] snarkJS: v1: 768d1754ec78ec26286727f90bb4daf228bf6191ac661b5df5e3046148b262b
[DEBUG] snarkJS: v6: 17505a0948f6e5fc5eac51e140b2aceb9be9820b81eb69c8f17ca1aaaa17d859
[DEBUG] snarkJS: u: cdb0b493e7f44b83cfe55b53d08c2e1ff655f078041aab6c221fe1864ab0c79
[DEBUG] snarkJS: Lagrange Evaluations: 
[DEBUG] snarkJS: L1(xi)=c87deea57e004d7f5b2a3a7caa45c19c877d9560f949ad256780bc1f58fd3cd
[DEBUG] snarkJS: Pl: 2fe608830e13c80afae5ecaf5a0c5bcf0cdeb4efc351b536637128e4073ead06
[DEBUG] snarkJS: t: 3ec3131c48683a5c59a0ac01993c856e3ad8459e205d9b423dfa9b5a8a0da82
[DEBUG] snarkJS: D: [ 16e5a09e9bcec79dff4fabd2698bd2eb2b4c66db1d70f0f3f151f56010da6226, 2aff4d1bf71b06d29eea253a6484339e44e925d1af6469d5a5922825c9379688 ]
[DEBUG] snarkJS: F: [ 837e158dd2dd893fd3a539475a1c513d1790db6e6d8546014e9208632d44040, 53a18b8cccbe64baba1ae753d3125117353d760c3ab8f61dc78b9ff5fdd2789 ]
[DEBUG] snarkJS: E: [ 23b43e6fa8bec1b92421bba5e6e2b378186fe77d97b6291b1c46c442e220492f, a59074e4bd3c512bfb6a2fc0eb39284794ae3db8982337cab9ff6de9432f1b4 ]
[INFO]  snarkJS: OK!
*/